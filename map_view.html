<!DOCTYPE html>
<html>
	<head>
		<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCXVaGdYMkavpAdFN7-j_65bAMRpmmdoYw"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
		<style>
      		html, body, #googleMap {
        		height: 100%;
        		margin: 0px;
        		padding: 0px;
      		}
    </style>
    	<!-- javascript code for AED object -->
    	<script type="text/javascript" src="aed_obj.js"></script>
    	<!-- test code for AED object -->
    	<script type="text/javascript" src="aedarr_test.js"></script>
    	<!-- test code for Marker and InfoWindow object -->
    	<script type="text/javascript" src="infowindowarr_test.js"></script>
		<script>
			var map;
			var currentCoord = new Coord(-1,-1);
			var aedArr = [];
			var markerArr = [];
			var infoWindowArr = [];
			var etaArr = [];
			var etaIconArr = [];
			var directionsService = new google.maps.DirectionsService();

			var httpCallBack = function(jsonStr, index){
				alert("index: " + index);
				alert("jsonStr: " + jsonStr);
			};

			function initialize() {
				/**
				 *  Google map initialization.
				 */
  				var mapProp = {
    				center:new google.maps.LatLng(25.0911,121.5598),
    				zoom:14,
    				mapTypeId:google.maps.MapTypeId.ROADMAP
  				};
  				map=new google.maps.Map(document.getElementById("googleMap"),mapProp);


  				/**
  				 *  test code that display three markers
  				 *  click on each marker pops up a infowindow
  				 */

  				makeDirectionsRequest(null, null, 3, null);

  				aedArr = testAedArr;
  				markerArr = createMarkerTestArr(3);
  				infoWindowArr = createInfoWindowTestArr(3);
  				setInfoWindowListener();
  				setMarkers(map);
  				/**
  				 * real code
  				 */

  				//placeholder for a function that updates currentCoord

  				//loadData(currentCoord);

  				//updateInfoWindows();

  				//updateMarkers();

  				//updateETAIcons(currentCoord);

			}
			google.maps.event.addDomListener(window, 'load', initialize);


			function loadData(coord){
				/** load AED data from files and modify aedArr
				 *
				 *  @param  coord  an Coord object that represents the current
				 *                 location
				 *  @modify aedArr
				 */
			}

			function createInfoWindow(aed){
				/** create an InfoWindow object (google map API) that display
				 *      the detail information of the AED object (input)
				 *
				 *  @param  aed  an AED object (see aed_obj.js)
				 *  @return      the created InfoWindow object
				 */

			}

			function updateInfoWindows(){
				/** create new InfoWindow objects and update infoWindowArr
				 *      based on the current aedArr
				 *
				 *  @param
				 *  @return
				 *  @modify  infoWindowArr
				 */
				 // set infoWindowArr to empty (not null)
				 infoWindowArr = [];
				 for (var i=0;i<aedArr.length;i++){
				 	infoWindowArr.push(createInfoWindow(aedArr[i]));
				 }
			}

			function createMarker(aed, infoWindow){
				/** create a marker that represents the AED object (input) and
				 *      contains the infoWindow (input)
				 *
				 *  @param  aed        an AED object that is used to create
				 *                     the marker
				 *  @param  infoWindow an InfoWindow object (google map API)
				 *                     that is going to popup when the marker
				 *                     is clicked
				 *  @return            generated marker
				 */
			}

			function updateMarkers(){
				/** create new markers and update markerArr based on the
				 *      current aedArr and infoWindowArr
				 *
				 *  @param
				 *  @return
				 *  @modify  markerArr
				 */
				//clear markerArr
				deleteMarkers();
				for (var i=0;i<aedArr.length;i++){
					markerArr.push(createMarker(aedArr[i], infoWindowArr[i]));
				}
				setInfoWindowListener();
				//pin markers to the map
				setMarkers(map);
			}

			function setInfoWindowListener(){
				for (var i=0;i<markerArr.length;i++){
  					var marker = markerArr[i];
  					var infoWindow = infoWindowArr[i];
					google.maps.event.addListener(marker, 'click', function(marker, infoWindow){
  						return function(){
  								infoWindow.open(map, marker);
  						}
  					}(marker, infoWindow));
				}
			}

			function deleteMarkers(){
				/** remove all markers from the map and set markerArr to empty
				 *      (not null)
				 *
				 *  @param
				 *  @return
				 *  @modify  markerArr
				 */
				setMarkers(null);
				markerArr = [];
			}

			function setMarkers(map){
				/** pin all markers to the map
				 *
				 *  @param
				 *  @return
				 *  @modify  markerArr
				 */
				for (var i=0;i<markerArr.length;i++){
					markerArr[i].setMap(map);
				}
			}

			function calculateETAAndUpdateArr(travelMode){
				/** 1. iterates through etaArr and calculate the ETAs
				 *  2. update etaArr
				 *  3. create etaIcon and update etaIconArr
				 *
				 *  @param  travelMode 'walking' or 'driving'
				 *  @return
				 *                     
				 */

				//clear etaIconArr
				deleteEtaIcons();
				etaArr = [];

				//calculate eta and update arrays
				for (var i = 0; i < aedArr.length; i++) {
					makeDirectionsRequest(currentCoord, aedArr[i], i, travelMode);
				}
			}

			function makeDirectionsRequest(coord, aed, index, travelMode) {
				/** 1. make directionService request using google map API
				 *  2. retrieve duration value (in sec) in the DirectionsResult
				 *         object and calculate the total duration
				 *  3. update etaArr
				 *  4. create etaIcon and update etaIconArr
				 *	
 				 *  @param  coord       coord of current location
 				 *  @param  aed         aed object to calculate the ETA
 				 *  @param  index       the index of {@paramref aed} in aedArr
 				 * 	@param  travelMode  'walking' or 'driving'
				 *
				 */

  				var request = {
    				origin: 'Sydney, NSW',
    				destination: 'Sydney, NSW',
    				waypoints:[{location: 'Bourke, NSW'}, {location: 'Broken Hill, NSW'}],
    				travelMode: google.maps.TravelMode.DRIVING
  				};

  				directionsService.route(request, function(response, status) {
    				if (status == google.maps.DirectionsStatus.OK) {
    					alert(index);
      					var eta = getDurationFromResultObj(response);
      					var etaIcon = createETAIcon(eta);
      					etaArr[index] = eta;
      					etaArr[index] = etaIcon;
      					setETAIcon(index);
    				}
  				});
			}

			function getDurationFromResultObj(resultObj){
				/** parse google.maps.DirectionsResult from google 
				 *      directions API and retrieve 'duration' values 
				 *      that represents the estimated time of arrival
				 *      and calcualte the summation of the values.
				 *
				 *  @param  resultObj DirectionsResult object from 
				 *                    google directions API
				 *  @return           total estimated time of arrival
				 *
				 *  note: resultObj is assumed to have only 1 route
				 *        if not, the sum of the first route's duration
				 *        is returned. 
				 */
			}

			function createETAIcon(eta){
				/** create an eta icon that display the estimated time
				 *      of arrival
				 *
				 *  @param  eta  the estimated time of arrival (input)
				 *  @return      the created eta icon
				 *
				 *  note: not sure which google map object should be
				 *        used. need survey.
				 */
			}

			function setETAIcon(index){
				//helper method (maybe needed).
				//set etaIcon[index] on the map

			}


		</script>
	</head>

	<body>
		<div id="googleMap"></div>
	</body>
</html>
